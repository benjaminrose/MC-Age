language: python

#matrix and generic is the best way to get travis to work with python & OSX
matrix:
  fast_finish: true
  allow_failures:
    - os: osx
    - env: MAIN_CMD="pylint fsps-age.py"
  include:
      - os: linux
        python: 3.5
        env: MAIN_CMD="pytest -v --cov-config=.coveragerc --cov"
      - os: linux
        python: 3.6
        env: MAIN_CMD="pytest -v --cov-config=.coveragerc --cov"
      - os: osx
        #will be python3 from homebrew
        language: generic
        env: 
          - PYVERSION=python3
          # Only run tests, not coverage
          - MAIN_CMD="pytest -v"
      - os: linux
        python: 3.6
        env: MAIN_CMD="pylint fsps-age.py"

# the old stuff
# os: 
#   - linux
#   - osx
# python:
#   - "3.5"
#   - "3.6"

notifications:
  email: never
  slack: 
    rooms: ndastrophysics:E9JMFDBpGWYdRcDneK7CTFdr
    on_success: change
    on_failure: always

# branches:
#   only:
#     - master

# get gfortran for linux builds
addons:
    apt:
        packages:
            - gfortran

# get gfortran, python3 & pystest for mac builds
before_install:
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew install gcc $PYVERSION && pip3 install --upgrade pip && pip3 install pytest; fi

install: 
  #download fsps
  - git clone https://github.com/cconroy20/fsps libfsps
  - cd libfsps/src
  # replace with a travis specific makefile
  # thanks to https://github.com/dfm/python-fsps/blob/master/.travis.yml
  - cp ../../.travis.Makefile Makefile
  - make all
  - cd ../..
  - export SPS_HOME=`pwd`/libfsps
  # install other packages
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then pip3 install -r requirements.txt; fi
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then pip install -r requirements.txt; fi
  # install coverage uploader & pytest plugin to test coverage.
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then pip install -r test-requirements.txt; fi

script: $MAIN_CMD

after_success: if [[ "$TRAVIS_OS_NAME" == "linux" ]]; codecov --token=38195770-d996-401c-b093-c245b36046f7; if
